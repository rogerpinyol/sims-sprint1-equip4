name: CI

on:
  push:
    branches:
      - users-CRUD
  pull_request:
    branches:
      - users-CRUD

jobs:
  phpunit:
    runs-on: ubuntu-latest

    services:
      mariadb:
        image: mariadb:10.11
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: test_db
          MARIADB_USER: test
          MARIADB_PASSWORD: test
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -utest -ptest --silent" --health-interval=10s --health-timeout=5s --health-retries=30 --health-start-period=60s

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install MySQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y mariadb-client

    - name: Install and start MariaDB
      run: |
        sudo apt-get update
        sudo apt-get install -y mariadb-server
        sudo service mysql start
        for i in {1..10}; do
          if sudo mysqladmin ping --silent; then
            echo "MariaDB is up and running!";
            break;
          fi;
          echo "Waiting for MariaDB to start... ($i/10)";
          sleep 3;
        done
        if ! sudo mysqladmin ping --silent; then
          echo "MariaDB failed to start.";
          exit 1;
        fi

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.3
        extensions: mbstring, pdo, pdo_mysql
        ini-values: post_max_size=256M, upload_max_filesize=256M, memory_limit=2G
        coverage: none
        tools: composer:v2

    - name: Verify PHP and Composer
      run: |
        php -v
        which php
        composer --version
        which composer

    - name: Prepare database
      run: |
        sudo mysql -e "CREATE USER IF NOT EXISTS 'test'@'%' IDENTIFIED BY 'test';"
        sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'test'@'%';"
        sudo mysql -e "FLUSH PRIVILEGES;"
        mariadb -h 127.0.0.1 -u test -ptest -e "CREATE DATABASE IF NOT EXISTS test_db;"
        mariadb -h 127.0.0.1 -u test -ptest test_db < config/init.sql
        if [ -f config/seed.sql ]; then
          mariadb -h 127.0.0.1 -u test -ptest test_db < config/seed.sql;
        else
          echo "Warning: config/seed.sql not found. Skipping seed step.";
        fi

    - name: Verify SQL files
      run: |
        if [ ! -f config/init.sql ]; then
          echo "Error: config/init.sql not found.";
          exit 1;
        fi
        if [ ! -f config/seed.sql ]; then
          echo "Error: config/seed.sql not found.";
          exit 1;
        fi

    - name: Install dependencies
      run: composer install --no-interaction --no-progress --prefer-dist

    - name: Debug environment variables
      run: |
        echo "MARIADB_DATABASE: $MARIADB_DATABASE"
        echo "MARIADB_DB: $MARIADB_DB"

    - name: Run PHPUnit
      env:
        MARIADB_HOST: 127.0.0.1
        MARIADB_PORT: 3306
        MARIADB_DATABASE: test_db
        MARIADB_DB: test_db
        MARIADB_USER: test
        MARIADB_PASSWORD: test
      run: |
        ./vendor/bin/phpunit --configuration phpunit.xml --testsuite Client,Manager --verbose

    - name: Dump MariaDB logs (on failure)
      if: ${{ failure() }}
      run: |
        docker ps -a
        ID=$(docker ps -aqf "name=mariadb")
        if [ -n "$ID" ]; then
          docker logs "$ID"
        fi
